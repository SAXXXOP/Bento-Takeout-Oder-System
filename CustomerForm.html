<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'sans-serif'; padding: 10px; font-size: 14px; }
      input, textarea { width: 100%; box-sizing: border-box; margin-bottom: 10px; padding: 8px; }
      .result-item { cursor: pointer; padding: 8px; border-bottom: 1px solid #eee; }
      .result-item:hover { background-color: #f0f0f0; }
      .btn-group { display: flex; gap: 5px; margin-bottom: 10px; }
      button { flex: 1; padding: 10px; cursor: pointer; border: none; border-radius: 4px; }
      .btn-active { background-color: #4CAF50; color: white; }
      .btn-save { background-color: #2196F3; color: white; width: 100%; margin-top: 10px; }
      #targetName { font-weight: bold; color: #333; margin-bottom: 10px; }
    </style>
  </head>
  <body>
    <h3>顧客検索</h3>
    <input type="text" id="searchInput" placeholder="氏名または電話番号を入力..." oninput="handleSearch()">
    <div id="status" style="color:#c00; margin:6px 0;"></div>
    <div id="results"></div>

    <div id="editSection" style="display:none;">
      <hr>
      <div id="targetName"></div>
      <div class="btn-group">
        <button id="tabKitchen" onclick="switchNote('kitchen')" class="btn-active">調理備考</button>
        <button id="tabOffice" onclick="switchNote('office')">事務備考</button>
      </div>
      <textarea id="noteText" rows="8"></textarea>
      <button class="btn-save" onclick="saveNote()">変更を保存</button>
    </div>

    <script>
      let selectedRow = null;
      let currentType = 'kitchen';
      let cache = { kitchen: "", office: "" };

      function setStatus(msg){ document.getElementById('status').innerText = msg || ""; }


      function handleSearch() {
        const query = document.getElementById('searchInput').value;
        if (query.length < 1) {
          document.getElementById('results').innerHTML = "";
          return;
        }
        setStatus("");
        google.script.run
          .withSuccessHandler(displayResults)
          .withFailureHandler(e => setStatus("Error: " + (e && e.message ? e.message : e)))
          .searchCustomers(query);
      }

      function displayResults(results) {
        const div = document.getElementById('results');
        div.innerHTML = "";
        results.forEach(res => {
          const item = document.createElement('div');
          item.className = 'result-item';
          item.innerText = `${res.name} (${res.tel})`;
          item.onclick = () => selectCustomer(res.row);
          div.appendChild(item);
        });
      }

      function selectCustomer(row) {
        setStatus("");
        google.script.run
        .withSuccessHandler(customer => {
          selectedRow = customer.row;
          // GASから返ってきた値を確実にセット
          cache.kitchen = customer.noteKitchen || "";
          cache.office = customer.noteOffice || "";
          
          document.getElementById('targetName').innerText = "編集： " + customer.name;
          document.getElementById('editSection').style.display = "block";
          document.getElementById('results').innerHTML = "";
          
          // 初期表示を「調理備考」に設定して表示更新
          currentType = 'kitchen';
          document.getElementById('noteText').value = cache.kitchen;
          updateTabUI();
        })
        .withFailureHandler(e => setStatus("Error: " + (e && e.message ? e.message : e)))
        .getCustomerByRow(row);
      }

      function switchNote(type) {
        // 現在の編集内容をキャッシュへ保存してから切り替え
        cache[currentType] = document.getElementById('noteText').value;
        
        currentType = type;
        document.getElementById('noteText').value = cache[type];
        updateTabUI();
      }

      function updateTabUI() {
        document.getElementById('tabKitchen').className = (currentType === 'kitchen') ? 'btn-active' : '';
        document.getElementById('tabOffice').className = (currentType === 'office') ? 'btn-active' : '';
      }

      function saveNote() {
        const note = document.getElementById('noteText').value;
        google.script.run.withSuccessHandler(msg => {
        setStatus("");
        google.script.run
        .withSuccessHandler(msg => {
          alert(msg);
          cache[currentType] = note;
        })
        .withFailureHandler(e => setStatus("Error: " + (e && e.message ? e.message : e)))
        .saveCustomerNote(selectedRow, note, currentType);
      }
    </script>
  </body>
</html>