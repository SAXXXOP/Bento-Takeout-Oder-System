<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: sans-serif; padding: 10px; font-size: 13px; }
    .row { display: flex; gap: 6px; align-items: center; }
    button { cursor: pointer; border: none; border-radius: 6px; padding: 8px 10px; }
    .btn { background: #e9eefc; }
    .btn-primary { background: #2b6cb0; color: #fff; }
    .btn-danger { background: #c53030; color: #fff; }
    input, textarea, select { width: 100%; box-sizing: border-box; padding: 8px; margin: 6px 0; }
    .list { border: 1px solid #eee; border-radius: 8px; max-height: 220px; overflow: auto; }
    .item { padding: 8px; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
    .item:hover { background: #f7fafc; }
    .item.active { background: #ebf8ff; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-top: 10px; }
    .muted { color: #666; font-size: 12px; }
    .tag { display:inline-block; padding:2px 6px; border-radius: 999px; background:#f1f5f9; margin-right:6px; font-size: 12px; }
    #status { margin-top: 8px; color: #333; }
  </style>
</head>
<body>
  <div class="row">
    <button class="btn-primary" onclick="refresh()">ğŸ”„ æ›´æ–°</button>
    <button class="btn" onclick="openRow()">é–‹ã</button>
    <div class="muted" id="count"></div>
  </div>

  <input id="filter" placeholder="çµã‚Šè¾¼ã¿ï¼ˆNo/åå‰/ç†ç”±ï¼‰" oninput="renderList()">

  <div class="list" id="list"></div>

  <div class="card" id="detail" style="display:none;">
    <div><span class="tag" id="t_date"></span><b id="t_no"></b></div>
    <div class="muted" id="t_meta"></div>

    <hr>

    <div id="suggest"></div>

    <div id="sec_tel" style="display:none;">
      <h4>é›»è©±ç•ªå·ãŒæœªå…¥åŠ›</h4>
      <input id="inp_tel" placeholder="é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ä¿å­˜">
      <button class="btn-primary" onclick="saveTel()">é›»è©±ã‚’ä¿å­˜</button>
    </div>

    <div id="sec_change" style="display:none;">
      <h4>å¤‰æ›´ï¼ˆå…ƒäºˆç´„Noã‚ã‚Šï¼‰</h4>
      <div class="muted">å…ƒäºˆç´„No: <b id="t_source"></b></div>
      <button class="btn-primary" onclick="applyChange()">å…ƒäºˆç´„ã‚’ç„¡åŠ¹åŒ–â†’ã“ã®æ³¨æ–‡ã‚’æœ‰åŠ¹åŒ–</button>
    </div>

    <hr>

    <h4>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç€åœ°</h4>
    <select id="reasonPreset"></select>
    <textarea id="reasonFree" rows="2" placeholder="ç†ç”±ï¼ˆè‡ªç”±å…¥åŠ›ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬+è¿½è¨˜ã§ã‚‚OKï¼‰"></textarea>

    <div class="row">
      <button class="btn-primary" onclick="markActive()">æœ‰åŠ¹ã«æˆ»ã™ï¼ˆç©ºæ¬„ï¼‰</button>
      <button class="btn" onclick="markNeeds()">â˜…è¦ç¢ºèªç¶­æŒ</button>
      <button class="btn-danger" onclick="markInvalid()">ç„¡åŠ¹ã«ã™ã‚‹</button>
    </div>

    <hr>

    <details>
      <summary>æ³¨æ–‡å†…å®¹ãƒ»è¦æœ›</summary>
      <div class="muted">æ³¨æ–‡å†…å®¹</div>
      <pre id="t_details" style="white-space:pre-wrap;"></pre>
      <div class="muted">è¦æœ›</div>
      <pre id="t_note" style="white-space:pre-wrap;"></pre>
    </details>
  </div>

  <div id="status" class="muted"></div>

<script>
  let items = [];
  let selected = null;
  let templatesNeeds = [];
  let templatesInvalid = [];

  function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }

  function refresh(){
    setStatus('æ›´æ–°ä¸­...');
    google.script.run
      .withSuccessHandler(async (list) => {
        items = list || [];
        document.getElementById('count').textContent = `(${items.length}ä»¶)`;
        if (!selected && items.length) selected = items[0];
        renderList();
        renderDetail();
        setStatus('OK');
      })
      .withFailureHandler(e => setStatus('Error: ' + (e && e.message ? e.message : e)))
      .ncw_refreshAndList();

    // ç†ç”±ãƒ†ãƒ³ãƒ—ãƒ¬ã‚‚ãƒ­ãƒ¼ãƒ‰ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
    google.script.run.withSuccessHandler(t => { templatesNeeds = t || []; fillReasonPresets(); }).ncw_getReasonTemplates('NEEDS_CHECK');
    google.script.run.withSuccessHandler(t => { templatesInvalid = t || []; }).ncw_getReasonTemplates('INVALID');
  }

  function renderList(){
    const q = (document.getElementById('filter').value || '').trim();
    const div = document.getElementById('list');
    div.innerHTML = '';
    items
      .filter(it => !q || (`${it.orderNo} ${it.name} ${it.reason}`.includes(q)))
      .forEach(it => {
        const el = document.createElement('div');
        el.className = 'item' + (selected && selected.row === it.row ? ' active' : '');
        const reason = it.reason ? ` - ${it.reason}` : '';
        el.textContent = `${it.pickupDate} / ${it.orderNo} / ${it.name}${reason}`;
        el.onclick = () => { selected = it; renderList(); renderDetail(); };
        div.appendChild(el);
      });
  }

  function renderDetail(){
    const box = document.getElementById('detail');
    if (!selected){ box.style.display = 'none'; return; }
    box.style.display = 'block';

    document.getElementById('t_date').textContent = selected.pickupDate || '';
    document.getElementById('t_no').textContent = selected.orderNo || '';
    document.getElementById('t_meta').textContent =
      `è¡Œ:${selected.row} / åå‰:${selected.name || 'ä¸æ˜'} / é›»è©±:${selected.tel || 'ãªã—'} / ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:${selected.timestamp || ''}`;

    document.getElementById('t_details').textContent = selected.details || '';
    document.getElementById('t_note').textContent = selected.note || '';

    // åˆ†å²è¡¨ç¤º
    const sug = [];
    if (selected.flags && selected.flags.hasSourceNo) sug.push('å¤‰æ›´ï¼ˆå…ƒäºˆç´„Noã‚ã‚Šï¼‰');
    if (selected.flags && selected.flags.needsTel) sug.push('é›»è©±æœªå…¥åŠ›');
    if (selected.flags && selected.flags.missingReason) sug.push('ç†ç”±æœªè¨˜å…¥');
    document.getElementById('suggest').innerHTML =
      sug.length ? `<div class="muted">ãŠã™ã™ã‚: ${sug.map(s=>`<span class="tag">${s}</span>`).join('')}</div>` : '';

    // é›»è©±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    document.getElementById('sec_tel').style.display = (selected.flags && selected.flags.needsTel) ? 'block' : 'none';
    document.getElementById('inp_tel').value = selected.tel || '';

    // å¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const hasSource = (selected.flags && selected.flags.hasSourceNo);
    document.getElementById('sec_change').style.display = hasSource ? 'block' : 'none';
    document.getElementById('t_source').textContent = selected.sourceNo || '';

    // ç†ç”±
    fillReasonPresets();
    document.getElementById('reasonFree').value = selected.reason || '';
  }

  function fillReasonPresets(){
    const sel = document.getElementById('reasonPreset');
    const cur = sel.value;
    sel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = 'ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠï¼‰';
    sel.appendChild(opt0);

    (templatesNeeds || []).forEach(t => {
      const o = document.createElement('option');
      o.value = t;
      o.textContent = t;
      sel.appendChild(o);
    });

    sel.value = cur || '';
    sel.onchange = () => {
      const v = sel.value;
      if (v) {
        const ta = document.getElementById('reasonFree');
        ta.value = ta.value ? (v + ' / ' + ta.value) : v;
        sel.value = '';
      }
    };
  }

  function openRow(){
    if (!selected) return;
    google.script.run.ncw_openOrderRow(selected.row);
  }

  function saveTel(){
    if (!selected) return;
    const tel = document.getElementById('inp_tel').value || '';
    google.script.run.withSuccessHandler(() => afterAction('é›»è©±ã‚’ä¿å­˜ã—ã¾ã—ãŸ'))
      .withFailureHandler(e => setStatus('Error: ' + (e.message || e)))
      .ncw_updateOrder(selected.row, { tel });
  }

  function reasonValue(required){
    const v = (document.getElementById('reasonFree').value || '').trim();
    if (required && !v) { alert('ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); throw new Error('reason required'); }
    return v;
  }

  function markActive(){
    if (!selected) return;
    google.script.run.withSuccessHandler(() => afterAction('æœ‰åŠ¹ã«æˆ»ã—ã¾ã—ãŸ'))
      .withFailureHandler(e => setStatus('Error: ' + (e.message || e)))
      .ncw_markActive(selected.row);
  }

  function markNeeds(){
    if (!selected) return;
    const r = reasonValue(false);
    google.script.run.withSuccessHandler(() => afterAction('â˜…è¦ç¢ºèªã®ã¾ã¾æ›´æ–°ã—ã¾ã—ãŸ'))
      .withFailureHandler(e => setStatus('Error: ' + (e.message || e)))
      .ncw_markNeedsCheck(selected.row, r);
  }

  function markInvalid(){
    if (!selected) return;
    const r = reasonValue(true);
    google.script.run.withSuccessHandler(() => afterAction('ç„¡åŠ¹ã«ã—ã¾ã—ãŸ'))
      .withFailureHandler(e => setStatus('Error: ' + (e.message || e)))
      .ncw_markInvalid(selected.row, r);
  }

  function applyChange(){
    if (!selected) return;
    const sourceNo = (selected.sourceNo || '').trim();
    if (!sourceNo) { alert('å…ƒäºˆç´„NoãŒç©ºã§ã™'); return; }
    google.script.run.withSuccessHandler((res) => afterAction(res && res.ok ? 'å¤‰æ›´å‡¦ç†å®Œäº†' : (res.message || 'å¤‰æ›´å‡¦ç†å¤±æ•—')))
      .withFailureHandler(e => setStatus('Error: ' + (e.message || e)))
      .ncw_applyChangeFlow(selected.row, sourceNo);
  }

  function afterAction(msg){
    setStatus(msg);
    // å†å–å¾—ã—ã¦æ¬¡ã¸
    selected = null;
    refresh();
  }

  // åˆæœŸè¡¨ç¤º
  refresh();
</script>
</body>
</html>
