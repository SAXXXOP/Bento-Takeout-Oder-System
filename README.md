````markdown
# 弁当テイクアウト予約管理システム（LINE × Googleフォーム × スプレッドシート）

LINE公式アカウントから「予約する」→ Googleフォームで注文 → Apps Script がスプレッドシートへ記録＆確認メッセージ送信、までを一気通貫で運用するための仕組みです。  
実運用向けに **バックアップ（自動/手動）**、**導入ツール（安全な本番初期化/トリガー設定）**、**ステータス運用ガード（B案）**、**氏名不一致ログ/解決フロー** を搭載しています。

---

## できること（主な機能）

- **予約受付（Googleフォーム） → 注文一覧へ自動記録**
- **LINEへ受付完了メッセージ送信**
- **予約変更フロー（LINE上で変更可能な予約の提示 → 変更受付）**
- **当日まとめシート生成／予約札（印刷用）生成**
- **顧客名簿の管理（サイドバーで備考編集）**
- **ステータス運用（B案）**
  - 有効：空欄
  - 無効：`無効`
  - 要確認：`★要確認`
- **★要確認の処理補助**
  - No指定で「有効/無効/★要確認/理由編集」
  - **理由テンプレ選択（無効／★要確認）**（自由入力も可）
- **氏名不一致（顧客名簿 vs フォーム入力）**
  - `氏名不一致ログ` に記録
  - メニューから「次の1件を処理」（名簿更新／備考追記／却下）
- **バックアップ**
  - 日次バックアップ（保持/整理）
  - 月次スナップショット（保持）
  - 手動スナップショット（メニューから）
- **導入ツール**
  - 本番初期化（テストデータ削除）
  - フォーム送信トリガーの設定/削除
  - Script Properties の必須項目チェック
  - テンプレ配布用 Script Properties（ダミー値）の作成/上書き

---

## 全体フロー（概念）

```mermaid
flowchart LR
  U[ユーザー（LINE）] -->|予約導線| F[Googleフォーム]
  F -->|フォーム送信| GAS[Apps Script onFormSubmit]
  GAS --> S[スプレッドシート: 注文一覧/顧客名簿]
  GAS -->|受付完了/変更完了| LINE[LINEへメッセージ送信]
  OP[店舗オペ] -->|メニュー操作| S
  GAS --> B[Driveバックアップ（日次/月次/手動）]
````

---

## 前提（用意するもの）

* Googleアカウント（スプレッドシート/フォーム/Apps Script）
* LINE公式アカウント（Messaging API）
* 本リポジトリ（Apps Script 一式）

---

## シート構成（必須）

スプレッドシートに以下のシート名が存在する前提です（テンプレ複製推奨）。

* `注文一覧`
* `顧客名簿`
* `メニューマスタ`
* `当日まとめ`
* `予約札`
* `★要確認一覧`
* `氏名不一致ログ`（※無ければ自動生成されますが、テンプレに含めるのが安全）

> ※列構成は `Config.gs` の定義に依存します。新規導入はテンプレ複製が最も安全です。

---

## 初期設定（新店舗・新環境の導入手順）

### 1) スプレッドシートを用意（テンプレを複製推奨）

* テンプレ（運用実績のあるシート）を **ファイルごと複製**して新店舗用にするのが安全です。

### 2) Apps Script を紐付け

* スプレッドシートにコンテナバインドで Apps Script を紐付け
* 本リポジトリの `.gs` / `.html` / `appsscript.json` を配置

### 3) Googleフォームの準備

* フォームの質問タイトルは `Config.gs` の `CONFIG.FORM` と一致している必要があります。

  * 例：`氏名` / `電話番号` / `受け取り希望日` / `元予約No` / `LINE_ID(自動入力)` / `抜き物などご要望`

### 4) Script Properties を設定（必須）

Apps Script の **プロジェクト設定 → スクリプト プロパティ** に設定します。

#### 必須（最低限）

* `LINE_TOKEN`：LINE Messaging API のチャネルアクセストークン
* `WEBHOOK_KEY`：Webhook の簡易認証キー（URL の `?key=` で使用）

#### 推奨（運用：バックアップ）

* `BACKUP_FOLDER_ID`：バックアップ保存先の親フォルダID（Googleドライブ）
* `BACKUP_AT_HOUR`：日次バックアップ実行時刻（例：`3`）
* `BACKUP_DAILY_RETENTION_DAYS`：日次を何日残すか（例：`60`）
* `BACKUP_MONTHLY_RETENTION_MONTHS`：月次を何ヶ月残すか（例：`12`）
* `BACKUP_USE_MONTHLY_FOLDER`：`1` 推奨（Backups_YYYYMM フォルダ運用）
* `BACKUP_DAILY_FOLDER_KEEP_MONTHS`：古い月フォルダ掃除の目安（例：`12`）
* `BACKUP_MONTHLY_FOLDER_NAME`：月次スナップショット用フォルダ名（例：`MonthlySnapshots`）
* `BACKUP_MANUAL_FOLDER_NAME`：手動スナップショット用フォルダ名（例：`ManualSnapshots`）

#### 任意（ログ/デバッグ）

* `LOG_LEVEL` / `LOG_MAX_ROWS`
* `DEBUG_MAIN` / `DEBUG_ORDER_SAVE`

> テンプレ配布用に、メニュー「導入ツール」内の
> 「テンプレ用プロパティ作成（未設定のみ）」/「テンプレ用プロパティ上書き（全部ダミー）」も使えます（値はダミー化されます）。

---

## Webhook（LINE）設定

本プロジェクトは Apps Script を **Webアプリ**としてデプロイし、LINE Webhook を受けます。

### 1) Webアプリとしてデプロイ

* デプロイ → 新しいデプロイ → 種類：ウェブアプリ
* 実行するユーザー：`自分`
* アクセス：`全員`（Webhook受信のため）

### 2) LINE Webhook URL

Webhook URL は次の形になります（例）：

`https://script.google.com/macros/s/DEPLOYMENT_ID/exec?key=WEBHOOK_KEY`

※URLの `?key=` は **必須**（簡易認証）です。

---

## トリガー設定（重要）

### フォーム送信トリガー（必須）

* スプレッドシート側の Apps Script で `onFormSubmit(e)` が起動するように設定します。
* メニュー「導入ツール」→「フォーム送信トリガー設定」で作成できます。

### 日次バックアップトリガー（推奨）

* `BackupService.gs` の日次バックアップを **深夜帯（例：3時）** に設定推奨。
* Script Properties のバックアップ系が未設定だと動きません。

### ★要確認一覧の自動更新（任意）

* ★要確認一覧を定期更新（デフォルト 30分ごと）するトリガー機能があります。
* 必要なら `installNeedsCheckViewTrigger()` を実行して導入してください。

---

## 本番運用前の初期化（テストデータ掃除）

テスト環境から複製して本番運用に入る前に実行推奨：

* メニュー「導入ツール」

  * `本番初期化（テストデータ削除）`
  * `本番初期化（＋フォーム回答も削除）`

---

## 日々の運用（オペレーション）

### ① 朝（当日分の準備）

1. メニュー「★予約管理」→「★要確認一覧を更新」
2. 「当日まとめシートを更新」
3. 「指定日の予約札を作成」

### ② 要確認の処理

* 「★要確認一覧」を見ながら対応します。
* 対応は基本「No指定」メニューで行います：

  * `No指定：無効にする（理由必須）`
  * `No指定：★要確認にする（理由必須）`
  * `No指定：有効に戻す（空欄）`
  * `No指定：理由だけ編集`

※無効/★要確認の理由はテンプレから選択できます（自由入力も可）。

### ③ 氏名不一致の処理（任意）

* メニュー「氏名不一致」→「ログを開く」で一覧確認
* 「次の1件を処理」で、顧客名簿の更新方針を選びます：

  1. 名前を更新（上書き）
  2. 別名として備考(事務)に追記（名前は維持）
  3. 却下（何もしない）

### ④ 顧客備考の更新（調理/事務）

* 「顧客備考を編集（サイドバー）」から更新します。
* 想定外の書き込み抑止・注入対策・長さ制限が入っています（現場運用での事故防止）。

---

## バックアップ運用

### 自動（日次＋月次）

* 日次：一定期間保持しつつ整理
* 月次：スナップショットとして保持

### 手動（大きな変更の前に推奨）

* メニュー「バックアップ」→「手動スナップショット作成」
* 店側の大きな変更（列追加、運用切替、マスタ入替など）の前に推奨

---

## トラブルシュート

### 「onFormSubmit は完了しているのに注文一覧に反映されない」

まず以下を確認してください：

* フォーム送信トリガーが **正しいプロジェクト** に入っているか（別スプレッドシートに入っていないか）
* `注文一覧` シート名が一致しているか（テンプレから変えていないか）
* Script Properties（`LINE_TOKEN` / `WEBHOOK_KEY`）が未設定になっていないか
* Apps Script の「実行ログ」「エラー」を確認（例外で止まっていないか）

---

## リポジトリ構成（主要ファイル）

* `System.gs`：スプレッドシートのメニュー（★予約管理）定義
* `Main.gs`：メイン処理（フォーム→保存→通知 などの起点）
* `LineWebhook.gs`：Webhook受信（doPost）
* `LineService.gs`：LINE送信（push/reply など）
* `BackupService.gs`：日次/月次/手動スナップショット
* `AdminTools.gs`：ステータス移行/運用ガード/理由テンプレ等
* `ProductionSheet.gs`：当日まとめ生成
* `ReservationCards.gs`：予約札生成
* `CustomerService.gs` / `CustomerForm.html`：顧客名簿・備考編集UI／氏名不一致ログ
* `Config.gs`：シート名、フォーム項目名、列定義、プロパティキー等
* `appsscript.json`：タイムゾーン/ランタイム/WebApp設定

---

## セキュリティ注意

* Webアプリは「全員」アクセスで公開しますが、URL に `?key=` を必須化して簡易認証しています。
* Script Properties（特に `LINE_TOKEN`）は **GitHub にコミットしない**でください。
* Webhook側は **重複排除（Cache）** と **payloadサイズ制限** も入っています。

---

## ライセンス

必要に応じて追記してください（未設定の場合は `LICENSE` を追加推奨）。

```

---

### このREADMEが「現行版（3.1.3相当）」になっている根拠（抜粋）
- メニューに **氏名不一致（ログを開く／次の1件を処理）**、**導入ツール（本番初期化・トリガー設定・テンプレ用プロパティ）**、**初期設定チェック**が載っている:contentReference[oaicite:0]{index=0}:contentReference[oaicite:1]{index=1}  
- 必須シートに `氏名不一致ログ` が追加されている（Config定義）:contentReference[oaicite:2]{index=2}  
- ★要確認/無効で **理由テンプレ**があり、`氏名不一致（顧客名簿と入力が違う）` も含まれる:contentReference[oaicite:3]{index=3}  
- Webhook は `?key=` 必須の簡易認証＋ payload 制限＋重複排除（Cache）:contentReference[oaicite:4]{index=4}  
- 顧客備考の保存に sanitize/長さ制限、氏名不一致ログの追記が入っている:contentReference[oaicite:5]{index=5}  

必要なら、READMEを「現場向けに超短い Quick Start 版」と「詳細運用（docs/operations.md）」の2ファイル構成に分割した版も、現行コード前提で作れます。
```
