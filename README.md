# 弁当予約フォーム（Googleフォーム + スプレッドシート + Apps Script）

Googleフォーム送信を起点に、スプレッドシートへ **注文一覧の記録 / 予約No発行 /（任意で）LINE自動返信** を行う運用ツールです。  
日々の業務として **予約札作成** と **当日まとめ更新** をメニューまたは自動（トリガー）で実行できます。

> 詳細手順は `docs/` にまとめています：[`docs/index.md`](docs/index.md)

---

## できること（概要）

- フォーム送信 → `注文一覧` に1行追加（予約No発行、要確認理由の付与、変更元予約Noの記録 など）
- 予約変更（フォームで「元予約No」入力）  
  条件を満たすと **旧予約を自動で無効化** して新予約へ置き換え
- ステータス運用（B案）
  - 有効：`""`（空）
  - 無効：`"無効"`
  - 要確認：`"★要確認"`
- 日次準備（当日まとめ + 予約札）を **手動/自動（トリガー）** で作成
- ★要確認ワークフロー（サイドバー）で、要確認を潰す導線を提供
- （任意）運用通知（1時間まとめ）：予約/変更を **メールでまとめて通知**
- （任意）締切後送信通知：締切後に送られた予約（無効扱い）を **メール通知**
- （任意）Driveバックアップ（日次 + 手動スナップショット）

---

## 先に結論：初期導入の最短手順

1. テンプレのスプレッドシート（このスクリプトが紐づいたもの）をコピー
2. Script Properties を設定（最低限：`LINE_TOKEN`, `WEBHOOK_KEY`）
3. フォーム送信トリガー（`onFormSubmit`）を設定
4. 余裕が出たら、日次準備トリガー / 運用通知トリガー / バックアップトリガーを設定

---

## 前提（シート）

### 必須タブ（テンプレ同梱前提）

- 注文一覧
- メニューマスタ
- 当日まとめ
- 予約札
- ★要確認一覧
- 休業日設定
- ログ

補足：
- `ログ` は存在しない場合でも自動作成されます（ただしテンプレにある前提で運用するのが安全）
- `運用通知キュー` は運用通知を使う場合に自動作成（自動で非表示）されます

> 「顧客名簿」タブは現行では **廃止** しています（顧客情報は `注文一覧` に集約）。  
> 個別のメモが必要な場合は、`注文一覧` の `NOTE`（備考）や `REASON`（要確認理由）を運用で使ってください。

### 注文一覧（列の意味：A〜P）
列位置は `Config.gs` の `CONFIG.COLUMN` で固定です（列の挿入/削除は危険）。

---

## Script Properties（必要な分だけ設定）

Apps Script → **プロジェクトの設定** → **スクリプト プロパティ**

### 最低限（推奨：コア）
- `LINE_TOKEN`：LINE Push（お客様への自動返信）に使用
- `WEBHOOK_KEY`：Webhook URL に `?key=` を必須化する簡易認証キー（未設定でも動きますが推奨）

### ログ（推奨）
- `LOG_LEVEL`（例：`INFO` / `DEBUG`）
- `LOG_MAX_ROWS`（ログ肥大化防止）

### 運用通知（任意：1時間まとめメール）
- `LATE_SUBMISSION_NOTIFY_TO`：宛先（カンマ区切り）
  - 運用通知（1時間まとめ）/ 締切後送信通知 の共通宛先として使います

### 締切後送信通知（任意）
- `LATE_SUBMISSION_NOTIFY_ENABLED`：`1/true/yes` で有効化

### 日次準備（任意：自動化）
- `DAILY_PREP_AT_HOUR`, `DAILY_PREP_AT_MINUTE`
- `DAILY_PREP_OFFSET_DAYS`（例：翌日分なら `1`）
- `DAILY_PREP_WEEKDAYS`（曜日制御、未設定なら毎日）

### バックアップ（任意）
- `BACKUP_FOLDER_ID`（Drive の親フォルダID）
- ほか保持期間/フォルダ運用の任意キーあり（詳細は docs 参照）

### 管理者/閲覧者（メニュー表示制御）
- `ADMIN_EMAILS`（カンマ区切り）
- `MENU_SHOW_ADVANCED`（互換・緊急用：全員に管理者メニューを出す）

詳しくは：`docs/setup/properties.md` / `docs/setup/menu-visibility.md`

---

## トリガー

- 必須：フォーム送信トリガー → `onFormSubmit`
- 任意：日次準備 → `dailyPrepTrigger`
- 任意：運用通知（1時間まとめ） → `opsNotifyHourlyTrigger`
- 任意：バックアップ → `backupSpreadsheetDaily`

詳しくは：`docs/setup/triggers.md`

---

## 使い方（運用）

スプレッドシートのメニュー **「★予約管理」** から実行します。

### 日々の運用（全員）
- 日次準備（当日まとめ予約札：指定日まとめて）
- ★要確認
  - ワークフロー（サイドバー）
  - 一覧を開く（更新して開く）
- 再実行（単体）
  - 当日まとめシートを更新
  - 指定日の予約札を作成

### 日々のメンテ（不定期・管理者）
- 不定期メンテ（管理者）
  - 【ステータス】理由未記入チェック / 監査 / B案移行 / 運用ガード再適用
  - 【バックアップ】手動 / 日次実行 / トリガー設定・停止
  - 【日次準備（自動化）】設定 / トリガー復旧・停止
  - 【運用通知（1時間まとめ）】トリガー作成・削除 / 疎通 / 手動送信
  - 【締切後送信通知（テスト）】疎通 / 抽出

### 導入時のみ（初回セットアップ・管理者）
- 導入時のみ（管理者）
  - 【本番初期化（危険）】テストデータ削除 / ＋フォーム回答も削除
  - 【トリガー（フォーム送信）】設定 / 削除
  - 【テンプレ配布（プロパティ）】キー作成 / 任意キー整理（最小化）

### 初期設定/復旧（必要時）
- 初期設定/復旧：初期設定チェック / 現在のプロパティ一覧（マスク）/ 権限チェック / メニュー再表示

---

## トラブルシュート

- まず見る場所：`ログ` タブ（+ Apps Script の実行履歴）
- よくある原因
  - フォーム質問タイトルが `CONFIG.FORM` と一致していない
  - 必須タブが揃っていない（名前違い含む）
  - トリガー未設定（`onFormSubmit`）
  - `LINE_TOKEN` 未設定で自動返信だけ失敗している

詳しくは：`docs/troubleshooting/logs.md`

---

## 開発メモ

- Apps Script ランタイム：V8
- タイムゾーン：Asia/Tokyo（店舗運用想定）

---

## License
TBD（店舗運用のみなら “All rights reserved” 扱いが無難です）
