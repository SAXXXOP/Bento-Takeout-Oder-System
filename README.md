# 弁当予約フォーム（Googleフォーム + スプレッドシート + Apps Script）

Googleフォームの送信を起点に、スプレッドシートへ **注文一覧の記録 / 予約No発行 / 自動返信（メール）** を行う運用ツールです。  
日々の業務として **予約札作成** と **当日まとめ更新** をメニューまたは自動（トリガー）で実行できます。

> 詳細手順は `docs/` にまとめています：[`docs/index.md`](docs/index.md)

---

## できること（概要）

- フォーム送信 → `注文一覧` に1行追加（予約No発行、要確認理由の付与、変更元予約Noの記録 など）
- ステータス運用（B案）
  - 有効：`""`（空）
  - 無効：`"無効"`
  - 要確認：`"★要確認"`
- 日次準備（当日まとめ + 予約札）を **手動/自動（トリガー）** で作成
- ★要確認ワークフロー（サイドバー）で、要確認を潰す導線を提供
- （任意）LINE連携：Webhook / Push 通知（Webアプリ公開 + `WEBHOOK_KEY` の簡易認証）
- （任意）Driveバックアップ（日次 + 手動スナップショット）

---

## 先に結論：初期導入の最短手順

1. テンプレのスプレッドシート（このスクリプトが紐づいたもの）をコピー
2. Script Properties を設定（必要な分だけ）
3. フォーム送信トリガー（`onFormSubmit`）を設定
4. 余裕が出たら、日次準備トリガー / バックアップトリガーを設定

---

## 前提（シート）

### 必須タブ（テンプレ同梱前提）

- 注文一覧
- メニューマスタ
- 当日まとめ
- 予約札
- ★要確認一覧
- 休業日設定
- ログ

> 「顧客名簿」タブは現行では **廃止** しています（顧客情報は `注文一覧` に集約）。  
> 個別のメモが必要な場合は、`注文一覧` の `NOTE`（備考）や `REASON`（要確認理由）を運用で使ってください。

### 注文一覧（列の意味：A〜P）

列位置は `Config.gs` の `CONFIG.COLUMN` で固定です（列の挿入/削除は危険）。

| 列 | キー | 意味 |
|---|---|---|
| A | TIMESTAMP | 受付時刻 |
| B | ORDER_NO | 予約No |
| C | TEL | 電話番号 |
| D | NAME | 氏名（任意入力） |
| E | PICKUP_DATE | 受け取り日/時刻（表示用） |
| F | NOTE | 抜き物などの要望（フォーム自由記入） |
| G | DETAILS | 注文明細（内部キー） |
| H | TOTAL_COUNT | 合計点数 |
| I | TOTAL_PRICE | 合計金額 |
| J | LINE_ID | LINE_ID（任意） |
| K | DAILY_SUMMARY | 当日まとめ用の集計情報（内部） |
| L | REGULAR_FLG | 常連フラグ（内部） |
| M | STATUS | ステータス（空/無効/★要確認） |
| N | REASON | ★理由（要確認理由/無効理由） |
| O | SOURCE_NO | 変更元予約No |
| P | PICKUP_DATE_RAW | 受け取り日（Date型・内部） |

---

## Script Properties（必要な分だけ設定）

Apps Script → **プロジェクトの設定** → **スクリプト プロパティ**

### よく使う（推奨）
- `LOG_LEVEL`（例：`INFO` / `DEBUG`）
- `LOG_MAX_ROWS`（ログ肥大化防止）

### LINE連携を使う場合（任意）
- `LINE_TOKEN`
- `WEBHOOK_KEY`（Webhook URL に `?key=` を必須化する簡易認証）

### バックアップを使う場合（任意）
- `BACKUP_FOLDER_ID`（Drive のフォルダID）

### 管理者/閲覧者（メニュー表示制御）
- `ADMIN_EMAILS`（カンマ区切り）
- 補足：メール判定できない環境向けのフォールバックとして `MENU_SHOW_ADVANCED` が残っています（全員に適用）。

詳しくは：`docs/setup/properties.md` / `docs/setup/menu-visibility.md`

---

## トリガー

- 必須：フォーム送信トリガー → `onFormSubmit`
- 任意：日次準備 → `dailyPrepTrigger`
- 任意：バックアップ → `backupSpreadsheetDaily`

詳しくは：`docs/setup/triggers.md`

---

## 使い方（運用）

スプレッドシートのメニュー **「★予約管理」** から実行します。

### 日々の運用（全員）
- 日次準備（当日まとめ予約札：指定日まとめて）
- ★要確認
  - ワークフロー（サイドバー）
  - 一覧を開く（更新して開く）
- 再実行（単体）
  - 当日まとめシートを更新
  - 指定日の予約札を作成

### 管理者のみ（ADMIN_EMAILS / オーナー）
- 予約No指定（直接処理）：有効/無効/★要確認、理由編集
- ステータス（監査/復旧）：監査、B案移行、運用ガード再適用
- バックアップ：手動/日次、トリガー設定/停止
- 導入ツール：本番初期化、トリガー設定、日次準備自動化、プロパティ整理 など
- 初期設定/復旧：初期設定チェック、権限チェック、メニュー再表示

---

## トラブルシュート

- まず見る場所：`ログ` タブ（+ Apps Script の実行履歴）
- よくある原因
  - フォーム質問タイトルが `CONFIG.FORM` と一致していない
  - 必須タブが揃っていない（名前違い含む）
  - トリガー未設定（`onFormSubmit`）

詳しくは：`docs/troubleshooting/` を参照してください。

---

## 開発メモ

- Apps Script ランタイム：V8
- タイムゾーン：Asia/Tokyo（店舗運用想定）

---

## License
TBD（店舗運用のみなら “All rights reserved” 扱いが無難です）
