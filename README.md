# 弁当予約フォーム（Googleフォーム + スプレッドシート + Apps Script）

Googleフォーム送信を起点に、スプレッドシートへ **注文一覧の記録 / 予約No発行 /（任意）通知（LINE・メール）** を行う運用ツールです。  
日々の業務として **予約札作成** と **当日まとめ更新** をメニュー、または自動（トリガー）で実行できます。

> 詳細手順は `docs/` にまとめています：[`docs/index.md`](docs/index.md)

---

## できること（概要）

### コア（業務が止まるライン）
- フォーム送信 → `注文一覧` に1行追加（予約No発行 / ステータス付与 / 理由付与）
- 予約変更（旧予約No + 電話番号照合）を自動処理（成立/不成立を分岐）
- 日次準備：指定日の **当日まとめ + 予約札** をまとめて作成（手動/自動）

### 運用支援
- ★要確認ワークフロー（サイドバー）で、要確認の処理導線を提供
- （任意）運用通知（予約/変更の1時間まとめ）をメール送信（キュー方式）
- （任意）締切後送信の検知メール（抽出/テスト）
- （任意）Driveバックアップ（日次 + 手動スナップショット）

---

## 先に結論：初期導入の最短手順

1. テンプレのスプレッドシート（このスクリプトが紐づいたもの）をコピー
2. フォームがこのスプレッドシートに紐づいていることを確認（`フォームの回答 1` が作られる状態）
3. Script Properties を設定（必要な分だけ）
4. フォーム送信トリガー（`onFormSubmit`）を設定（メニューから）
5. 余裕が出たら、日次準備（自動）/ バックアップ / 運用通知（メール）を設定

導入手順：[`docs/setup/initial-setup.md`](docs/setup/initial-setup.md)

---

## 前提（シート）

### 必須タブ（テンプレ同梱前提）
- 注文一覧
- メニューマスタ
- 当日まとめ
- 予約札
- ★要確認一覧
- 休業日設定
- ログ

> 「顧客名簿」タブは現行では **廃止**（顧客情報は `注文一覧` に集約、常連判定は直近の注文一覧スキャンで行います）。  
> 個別の伝達事項は `注文一覧` の `NOTE`（備考）や `REASON`（理由）を運用で使ってください。

### 注文一覧（列の意味：A〜P）
列位置は `Config.gs` の `CONFIG.COLUMN` で固定です。**列の挿入/削除は危険**です。

| 列 | キー | 意味 |
|---|---|---|
| A | TIMESTAMP | 受付時刻 |
| B | ORDER_NO | 予約No |
| C | TEL | 電話番号 |
| D | NAME | 氏名（任意入力） |
| E | PICKUP_DATE | 受け取り日/時刻（表示用） |
| F | NOTE | 抜き物などの要望（フォーム自由記入） |
| G | DETAILS | 注文明細（内部キー） |
| H | TOTAL_COUNT | 合計点数 |
| I | TOTAL_PRICE | 合計金額 |
| J | LINE_ID | LINE_ID（任意） |
| K | DAILY_SUMMARY | 当日まとめ用の集計情報（内部） |
| L | REGULAR_FLG | 常連フラグ（内部） |
| M | STATUS | ステータス（空/無効/★要確認） |
| N | REASON | ★理由（要確認理由/無効理由） |
| O | SOURCE_NO | 変更元予約No |
| P | PICKUP_DATE_RAW | 受け取り日（Date型・内部） |

**重要（先頭0落ち対策）**  
- 列B（予約No）、列C（電話番号）は「プレーンテキスト」推奨です（数値扱いで先頭0が落ちたり、日付化する事故を防ぐ）。

---

## ステータス運用（B案）
- 有効：`""`（空）
- 無効：`"無効"`
- 要確認：`"★要確認"`

---

## Script Properties（必要な分だけ）

Apps Script → **プロジェクトの設定** → **スクリプト プロパティ**

### 必須（初期設定チェックでは必須扱い）
- `LINE_TOKEN`
- `WEBHOOK_KEY`

> 補足：このプロジェクトは「LINE/WEBHOOK をコアに含める」前提のため、`checkScriptProperties`（初期設定チェック）ではこの2つが必須扱いです。

### 推奨（ログ）
- `LOG_LEVEL`（例：`INFO` / `WARN`）
- `LOG_MAX_ROWS`（例：`2000`）

### 任意（使う場合だけ）
- バックアップ：`BACKUP_FOLDER_ID`, `BACKUP_AT_HOUR`（ほか保持設定は任意）
- 日次準備（自動化）：`DAILY_PREP_*`
- 締切後送信通知：`LATE_SUBMISSION_NOTIFY_ENABLED`, `LATE_SUBMISSION_NOTIFY_TO`
- メニュー表示（管理者/閲覧者）：`ADMIN_EMAILS`（互換フォールバック：`MENU_SHOW_ADVANCED`）

詳細：[`docs/setup/properties.md`](docs/setup/properties.md)

---

## トリガー

- 必須：フォーム送信トリガー → `onFormSubmit`
- 任意：日次準備（自動）→ `dailyPrepTrigger`
- 任意：日次バックアップ → `backupSpreadsheetDaily`
- 任意：運用通知（1時間まとめ）→ `opsNotifyHourlyTrigger`

詳細：[`docs/setup/triggers.md`](docs/setup/triggers.md)

---

## 使い方（運用）

スプレッドシートのメニュー **「★予約管理」** から実行します。

### 日々の運用（全員）
- `日次準備（当日まとめ予約札：指定日まとめて）`（基本これだけでOK）
- `★要確認`
  - `ワークフロー（サイドバー）`
  - `一覧を開く（更新して開く）`
- `再実行（単体）`
  - `当日まとめシートを更新`
  - `指定日の予約札を作成`

日次の流れ：[`docs/operations/daily-check.md`](docs/operations/daily-check.md)

### 不定期メンテ（管理者）
- `不定期メンテ（管理者）`
  - 【ステータス】理由未記入チェック / 監査 / B案移行 / 運用ガード再適用
  - 【バックアップ】手動スナップショット / 日次バックアップ（今すぐ）/ トリガー設定・停止
  - 【日次準備（自動化）】設定（時刻/オフセット/曜日）/ トリガー復旧・停止
  - 【運用通知（1時間まとめ）】トリガー作成・削除 / 疎通（Ping）/ 手動送信
  - 【締切後送信通知（テスト）】疎通（Ping）/ 抽出（本文確認）

### 導入時のみ（管理者）
- `導入時のみ（管理者）`
  - 【本番初期化（危険）】テストデータ削除 / ＋フォーム回答も削除
  - 【トリガー（フォーム送信）】設定 / 削除
  - 【テンプレ配布（プロパティ）】キー作成（未設定のみ） / 任意キーをまとめて整理（最小化）

### 初期設定/復旧（必要時）
- `初期設定/復旧`
  - （管理者）初期設定チェック（Script Properties）
  - （管理者）現在のプロパティ一覧（マスク）
  - （全員）権限チェック（管理者/閲覧者）
  - （全員）🔄 メニューを再表示（設定再読込）

---

## トラブルシュート

- まず見る場所：`ログ` タブ（＋ Apps Script の実行履歴）
- よくある原因
  - フォーム質問タイトルが `CONFIG.FORM` と一致していない（質問文を変えた）
  - 必須タブが揃っていない（名前違い含む）
  - トリガー未設定（`onFormSubmit`）
  - 電話番号/予約No の列が数値扱いで崩れている（先頭0落ち・日付化）

ログ手順：[`docs/troubleshooting/logs.md`](docs/troubleshooting/logs.md)

---

## 開発メモ
- Apps Script ランタイム：V8
- タイムゾーン：Asia/Tokyo（店舗運用想定）
- 設定の集約：`Config.gs`（シート名/列/プロパティキー/フォーム質問タイトル）

---

## License
TBD（店舗内運用のみなら “All rights reserved” 扱いが無難です）
