# Bento Takeout Order System（弁当予約フォーム / 予約管理）

Googleフォーム + Googleスプレッドシート + Apps Script + LINE Messaging API で動く、弁当の「予約受付・台帳管理・当日まとめ・予約札印刷・予約変更」システムです。

- お客様：LINE から予約（フォームを開く）／予約変更（トーク上で選択→再予約）
- 店舗：スプレッドシートで注文一覧を管理し、当日まとめや予約札を自動生成

---

## 主な機能

### 予約受付（フォーム送信→台帳記録→LINE通知）
- フォーム送信をトリガーに「注文一覧」へ記録
- 予約番号を自動採番（例：`0203-1`）
- LINEへ予約内容を Push 通知

### 予約変更（LINEトーク上で完結）
- LINEで「変更対象の予約」をカルーセル表示→選択
- Googleフォームを **プリフィル（LINE_ID / 元予約No）** して開く
- 送信後、旧予約を無効化（ステータス運用で追跡）

> 予約変更の締切は「前日20:00」運用（コード側で締切判定を持っています）

### 当日まとめ（仕込み・提供用の集計）
- 指定日を入力して「当日まとめ」シートを再生成
- グループ集計・内訳・メモ（調理備考）などを見やすく出力

### 予約札（印刷用）
- 指定日を入力して「予約札」シートを再生成
- 2〜3列の最適配置（ビンパッキング）＋ページ境界（46行）を考慮

### ★要確認一覧（運用ガード）
- LINE_ID未取得、電話未入力、データ不整合などを「★要確認」として一覧化
- 定期更新トリガー（例：30分ごと）をインストール可能

### 顧客管理（サイドバー）
- スプレッドシート上のサイドバーで顧客検索・備考（調理/事務）編集

---

## システム構成（ざっくり）

1. **LINE（リッチメニュー / トーク）**
   - 「予約する」→ LIFF/URL で Googleフォームへ
   - 「予約を変更する」→ Webhook（Apps Script `doPost`）へ

2. **Googleフォーム**
   - 予約内容を回答
   - `LINE_ID(自動入力)` / `元予約No` を（変更時は）プリフィル

3. **スプレッドシート（台帳）**
   - 注文一覧 / 顧客名簿 / メニューマスタ / 当日まとめ / 予約札 / ★要確認一覧

4. **Apps Script**
   - `onFormSubmit(e)`：フォーム送信処理
   - `doPost(e)`：LINE Webhook（予約変更UI・導線）

---

## 店舗への新規導入手順（セットアップ手順）

### 0) 事前に用意するもの
- Googleアカウント（店舗用推奨）
- LINE公式アカウント（Messaging API有効化）
- （任意）既存のスプレッドシート・フォームのテンプレ

### 1) スプレッドシート（台帳）を作成
以下のシート名で作成してください（名前が一致している必要があります）。

- 注文一覧
- 顧客名簿
- メニューマスタ
- 当日まとめ
- 予約札
- ★要確認一覧

> 列構成は `Config.gs` に依存します。運用開始前に列を固定してください（列の入れ替えはNG）。

### 2) メニューマスタを入力
`メニューマスタ` は概ね下記の列を想定しています。

- A: ID
- B: グループ
- C: メニュー名（フォーム質問文の親）
- D: サブメニュー（グリッド選択肢など）
- E: 価格
- F: 略称（内部キー・表示用短縮）

### 3) Googleフォームを作成（予約フォーム）
- 回答先を「上記スプレッドシート」に設定
- 質問タイトル（文言）を `Config.gs` の `CONFIG.FORM` と一致させる  
  （例：氏名 / 電話番号 / 受け取り希望日 / 元予約No / LINE_ID(自動入力) / 抜き物などご要望 …）

#### 予約変更のプリフィル（重要）
予約変更時は、フォームURLに `entry.xxxxxx` を付けて
- LINE_ID
- 元予約No
を自動入力します。

そのため、フォームの該当項目の **entry ID** を `CONFIG.LINE.ENTRY_LINE_ID / ENTRY_OLD_NO` に設定してください。

### 4) Apps Script をスプレッドシートに紐付け
- スプレッドシート → 拡張機能 → Apps Script
- このリポジトリの `.gs` / `.html` を同名で追加（貼り付け）

### 5) スクリプトプロパティを設定
Apps Script → プロジェクトの設定 → スクリプトプロパティ に追加：

- `LINE_TOKEN`：LINEチャネルアクセストークン（必須）
- `WEBHOOK_KEY`：Webhook URL の簡易認証キー（推奨）
- （任意）ログ関連：`LOG_LEVEL` など（実装に合わせて）

### 6) トリガー設定（フォーム送信）
Apps Script → トリガー から、`onFormSubmit` を「フォーム送信時」または「スプレッドシートのフォーム送信時」でインストールしてください。

### 7) Webアプリとしてデプロイ（LINE Webhook）
Apps Script → デプロイ → 新しいデプロイ → 種類：ウェブアプリ

- 実行するユーザー：自分
- アクセス：全員（匿名ユーザー含む）

Webhook URL は以下の形式にします：
https://script.google.com/macros/s/<DEPLOY_ID>/exec?key=<WEBHOOK_KEY>


### 8) LINE 側の設定
- Messaging API の Webhook URL に上記を設定
- リッチメニューに「予約する」導線（LIFF/フォームURL）を設定
- 予約変更の導線（例：「予約を変更する」などのメッセージ/ボタン）を用意

---

## 運用手順（店舗側）

### 日次
1. 「★要確認一覧」を確認（止めて確認が必要な予約がないか）
2. 当日分の「当日まとめ」を生成（`createProductionSheet` を実行）
3. 当日分の「予約札」を生成（`createDailyReservationCards` を実行）
4. 印刷・仕込み・受け渡し運用

### 予約変更が入った時
- お客様が「再予約」送信後、旧予約は自動で無効化される設計
- 必要に応じて「理由」列を見て追跡

---

## スプレッドシート仕様（Config.gs 抜粋）

### 注文一覧（例）
|列|内容|
|---|---|
|A|タイムスタンプ|
|B|予約番号|
|C|電話番号|
|D|名前|
|E|受け取り希望日（表示用）|
|F|リクエスト/備考|
|G|商品詳細|
|H|総数|
|I|合計金額|
|J|LINE_ID|
|K|当日まとめ用|
|L|常連フラグ|
|M|ステータス（B案：空欄=有効 / 無効 / ★要確認）|
|N|理由|
|O|変更元予約No|
|P|受取日 Date型（内部用）|

---

## よくあるトラブルシュート

### LINEが返らない / Webhookが動かない
- `LINE_TOKEN` が未設定 or 間違い
- WebアプリURLが古い（デプロイし直したらWebhook URLも更新）
- `WEBHOOK_KEY` が一致していない（URLの `?key=` を確認）

### 予約変更候補が出ない
- 締切（前日20:00）を過ぎている
- 対象予約が「無効」になっている／ステータスが有効（空欄）ではない
- 「注文一覧」の列ズレ・シート名不一致

### 当日まとめ/予約札が空
- 対象日付の表記揺れ（例：`2/14` 推奨）
- 注文一覧の「受取日」列（表示/内部）やメニュー表の紐付けが崩れている

---

## ファイル構成（役割）

- `Main.gs`：フォーム送信トリガー（受付→保存→通知）
- `LineWebhook.gs`：LINE Webhook（予約変更カルーセル/プリフィルURL生成）
- `Config.gs`：全体設定（シート名・列番号・フォーム質問タイトル・entry IDなど）
- `OrderService.gs`：注文一覧への保存、旧予約の無効化など
- `ReservationService.gs`：予約番号採番、変更フロー一時データ掃除
- `ProductionSheet.gs`：当日まとめ生成
- `ReservationCards.gs`：予約札生成
- `NeedsChechView.gs`：★要確認一覧生成・定期更新トリガー
- `CustomerService.gs` / `CustomerForm.html` / `System.gs`：顧客管理サイドバー
- `SecurityUtils.gs`：シート注入対策・ログ短縮など
- `SheetLogger.gs`：ログシート出力（任意）

---

## ライセンス
未設定の場合は `LICENSE` を追加して運用してください。

