```markdown
# 弁当テイクアウト予約管理システム（LINE × Googleフォーム × スプレッドシート）

LINE公式アカウントから「予約する」→ Googleフォームで注文 → Apps Script がスプレッドシートへ記録＆確認メッセージ送信、までを一気通貫で運用するための仕組みです。

実運用向けに、以下を搭載しています：

- バックアップ（自動/手動）
- 導入ツール（安全な本番初期化 / トリガー設定 / 日次準備トリガー設定）
- ステータス運用（無効/★要確認）と理由管理
- ★要確認の処理補助（No指定メニュー）
- 氏名不一致ログ/解決フロー
- 顧客備考の編集（サイドバー）
- メニュー表示制御（運用者向けに危険メニューを隠せる）

---

## 全体フロー（概要）

- LINE →（予約導線）→ Googleフォーム
- フォーム送信 → `onFormSubmit` → 注文一覧へ記録（必要に応じて顧客名簿更新）
- 受付完了/変更完了は LINE へ自動返信
- 店舗側はスプレッドシートのメニュー操作で「当日まとめ」「予約札」「★要確認」「バックアップ」などを実行

---

## シート構成（必須）

テンプレ複製での導入を推奨します（列構成は `Config.gs` 定義に依存）。

- `注文一覧`
- `顧客名簿`
- `メニューマスタ`
- `当日まとめ`
- `予約札`
- `★要確認一覧`
- `氏名不一致ログ`（無ければ自動生成されますが、テンプレに含めるのが安全）

---

## 初期設定（新店舗・新環境の導入手順）

### 1) スプレッドシートを用意（テンプレ複製推奨）
運用実績のあるテンプレを「ファイルごと複製」して使うのが安全です。

### 2) Apps Script を紐付け
- 複製したスプレッドシート → 拡張機能 → Apps Script
- 本リポジトリの `.gs` / `.html` / `appsscript.json` を反映

### 3) Script Properties を設定（必須/推奨）
Apps Script の「プロジェクトの設定」→「スクリプト プロパティ」に設定します。

#### 必須（最低限）
- `LINE_TOKEN`：LINE Messaging API のチャネルアクセストークン
- `WEBHOOK_KEY`：Webhook の簡易認証キー（WebアプリURLの `?key=` で使用）

#### 推奨（運用：バックアップ）
- `BACKUP_FOLDER_ID`：バックアップ保存先の親フォルダID
- `BACKUP_AT_HOUR`：日次バックアップ実行時刻（例：`3`）
- `BACKUP_DAILY_RETENTION_DAYS`：日次を何日残すか（例：`60`）
- `BACKUP_MONTHLY_RETENTION_MONTHS`：月次を何ヶ月残すか（例：`12`）
- `BACKUP_USE_MONTHLY_FOLDER`：`1` 推奨
- `BACKUP_DAILY_FOLDER_KEEP_MONTHS`：古い月フォルダ掃除の目安（例：`12`）
- `BACKUP_MONTHLY_FOLDER_NAME`：月次スナップショット用フォルダ名（例：`MonthlySnapshots`）
- `BACKUP_MANUAL_FOLDER_NAME`：手動スナップショット用フォルダ名（例：`ManualSnapshots`）

#### 推奨（運用：日次準備＝当日まとめ+予約札）
- `DAILY_PREP_AT_HOUR`：実行時刻（時）（例：`7`）
- `DAILY_PREP_AT_MINUTE`：実行時刻（分）（例：`0`）
- `DAILY_PREP_OFFSET_DAYS`：対象日のオフセット（例：`0`=今日、`1`=明日）
- `DAILY_PREP_WEEKDAYS`：実行対象の曜日（任意。`1(月)〜7(日)` / 例：`1-5`=月〜金 / 空欄=全曜日）

#### 任意（ログ/デバッグ）
- `LOG_LEVEL` / `LOG_MAX_ROWS`
- `DEBUG_MAIN` / `DEBUG_ORDER_SAVE`

#### 任意（メニュー表示の制御）
現場が触らない（または誤操作リスクのある）メニューを非表示にできます。  
`1/true/yes`=表示、`0/false/no`=非表示（未設定の場合は基本「表示」になります）。

- `MENU_SHOW_ADVANCED`：詳細メニュー全体（サブメニュー類）
- `MENU_SHOW_ORDERNO`：No指定ツール
- `MENU_SHOW_NAME_CONFLICT`：氏名不一致ツール
- `MENU_SHOW_STATUS`：ステータス関連ツール
- `MENU_SHOW_BACKUP`：バックアップ
- `MENU_SHOW_SETUP`：導入ツール
- `MENU_SHOW_PROP_CHECK`：初期設定チェック（Script Properties）

> プロパティ変更後は、スプレッドシートを開き直すか  
> `🔄 メニューを再表示（設定再読込）` を実行して反映してください。

---

## Webhook（LINE）設定

本プロジェクトは Apps Script を **Webアプリ**としてデプロイし、LINE Webhook を受けます。

### 1) Webアプリとしてデプロイ
- デプロイ → 新しいデプロイ → 種類：ウェブアプリ
- 実行するユーザー：`自分`
- アクセス：`全員`（Webhook受信のため）

### 2) LINE Webhook URL
Webhook URL は次の形になります（例）：

`https://script.google.com/macros/s/DEPLOYMENT_ID/exec?key=WEBHOOK_KEY`

※URLの `?key=` は **必須**（簡易認証）です。

---

## トリガー設定（重要）

### フォーム送信トリガー（必須）
- スプレッドシート側の Apps Script で `onFormSubmit(e)` が起動するように設定します。
- メニュー `導入ツール` → `フォーム送信トリガー設定` で作成できます（削除も可）。

### 日次準備トリガー（推奨：当日まとめ+予約札）
- 毎日指定時刻に `当日まとめ` と `予約札` を自動作成します。
- メニュー `導入ツール` → `日次準備設定（時刻/オフセット/曜日）` で設定を保存できます。
- メニュー `導入ツール` → `日次準備トリガー設定` でトリガーを作成できます（削除も可）。
- `DAILY_PREP_WEEKDAYS` を設定している場合、対象曜日以外は自動実行をスキップします。

### 日次バックアップトリガー（推奨）
- 日次バックアップは深夜帯（例：3時）を推奨します。
- Script Properties のバックアップ系が未設定だと動きません。

---

## メニューマスタ（表示名まわり）

`メニューマスタ` は「正式名」「小メニュー」「略称」などを持ちます。  
略称（内部キー）は内部処理や一部の表示で使われます。

- 予約完了/変更完了の自動返信で「見やすい商品名」を出したい場合、表示用の列を使います。
- 現行の列定義には `AUTO_REPLY_NAME` が含まれています（自動返信向け表示名などの用途）。  
  店舗の運用ルールに合わせて利用してください。

---

## メニュー一覧（★予約管理）

スプレッドシートを開くとメニュー `★予約管理` が表示されます。

### 日々の運用（よく使う）
- `★要確認一覧を更新`
- `当日まとめシートを更新`
- `指定日の予約札を作成`
- `日次準備（当日まとめ予約札：指定日まとめて）`
- `★要確認一覧を開く`
- `顧客備考を編集（サイドバー）`

### 要確認の処理（予約No指定）※詳細メニュー（表示制御可）
`No指定`（サブメニュー）
- `No指定：有効に戻す（空欄）`
- `No指定：無効にする（理由必須）`
- `No指定：★要確認にする（理由必須）`
- `No指定：理由だけ編集`

### 氏名不一致の処理（任意）※詳細メニュー（表示制御可）
`氏名不一致`（サブメニュー）
- `ログを開く`
- `次の1件を処理`（名簿更新/備考追記/却下）

### ステータス/監査（任意）※詳細メニュー（表示制御可）
- `理由未記入チェック`
- `ステータス運用ガード適用`
- `ステータス監査（値の件数）`
- `ステータス移行（B案）`

### バックアップ（任意）※詳細メニュー（表示制御可）
`バックアップ`（サブメニュー）
- `手動スナップショット作成`

### 導入ツール（任意）※詳細メニュー（表示制御可）
`導入ツール`（サブメニュー）
- `本番初期化（テストデータ削除）`
- `本番初期化（＋フォーム回答も削除）`
- `フォーム送信トリガー設定`
- `フォーム送信トリガー削除`
- `日次準備設定（時刻/オフセット/曜日）`
- `日次準備トリガー設定`
- `日次準備トリガー削除`
- `テンプレ用プロパティ（ダミー）作成`
- `テンプレ用プロパティ（ダミー）上書き`

### 初期設定チェック（任意）※詳細メニュー（表示制御可）
- `初期設定チェック（Script Properties）`

### 反映用（いつでも使える）
- `🔄 メニューを再表示（設定再読込）`

---

## 日々の運用（オペレーション例）

### ① 朝（当日分の準備）
- `★要確認一覧を更新`
- （自動化していない場合）
  - `当日まとめシートを更新`
  - `指定日の予約札を作成`
  - まとめて実行する場合は `日次準備（当日まとめ予約札：指定日まとめて）`

> 日次準備トリガーを入れている場合は、朝の作成が自動化されます。

### ② 要確認の処理
- `★要確認一覧` を見ながら対応
- 対応は基本 `No指定` メニューで行う（事故が減る）

### ③ 氏名不一致の処理（任意）
- `氏名不一致` → `ログを開く`
- `次の1件を処理` で方針選択（上書き/備考追記/却下）

### ④ 顧客備考の更新（調理/事務）
- `顧客備考を編集（サイドバー）`

---

## バックアップ運用

### 自動（日次＋月次）
- 日次：一定期間保持しつつ整理
- 月次：スナップショットとして保持

### 手動（大きな変更の前に推奨）
- `バックアップ` → `手動スナップショット作成`
- 列追加、運用切替、マスタ入替などの前に推奨

---

## トラブルシュート

### 「onFormSubmit は完了しているのに注文一覧に反映されない」
まず以下を確認：

- フォーム送信トリガーが **正しいプロジェクト** に入っているか（別スプレッドシートに入っていないか）
- `注文一覧` シート名が一致しているか（テンプレから変えていないか）
- Script Properties（`LINE_TOKEN` / `WEBHOOK_KEY`）が未設定になっていないか
- Apps Script の実行ログ/エラーを確認

### 「日次準備が自動で走らない」
- 日次準備トリガーが作成されているか（導入ツールで再設定）
- `DAILY_PREP_AT_HOUR` / `DAILY_PREP_AT_MINUTE` が設定されているか
- `DAILY_PREP_WEEKDAYS` を設定している場合、対象曜日に該当しているか（対象外はスキップ）

### 「LINE返信が来ない」
- Webアプリのデプロイが最新か
- Webhook URL の `?key=` が正しいか（`WEBHOOK_KEY` と一致するか）
- `LINE_TOKEN` が有効か（期限/権限/貼り間違い）

---

## セキュリティ注意

- Webアプリは「全員」アクセスで公開しますが、URL に `?key=` を必須化して簡易認証しています。
- Script Properties（特に `LINE_TOKEN`）は **GitHub にコミットしない**でください。

---

## ライセンス
必要に応じて追記してください。
```

```
