# 弁当テイクアウト予約管理システム（LINE × Googleフォーム × スプレッドシート）

LINE公式アカウントから「予約する」→ Googleフォームで注文 → Apps Script がスプレッドシートへ記録＆確認メッセージ送信、までを一気通貫で運用するための仕組みです。

実運用向けに以下を搭載しています：
- バックアップ（自動/手動）
- 導入ツール（安全な本番初期化 / トリガー設定）
- ステータス運用ガード（B案）
- 氏名不一致ログ/解決フロー
- 日次準備（当日まとめ + 予約札）自動作成

---

## できること（主な機能）

- **予約受付（Googleフォーム） → 注文一覧へ自動記録**
- **LINEへ受付完了メッセージ送信**
- **予約変更フロー（LINE上で変更可能な予約の提示 → 変更受付）**
- **当日まとめシート生成／予約札（印刷用）生成**
- **日次準備（当日まとめ + 予約札）**
  - 指定時刻に毎日自動作成（トリガー）
  - 手動で日付入力してまとめて作成（プロンプト1回）
- **顧客名簿の管理（サイドバーで備考編集）**
- **ステータス運用（B案）**
  - 有効：空欄
  - 無効：`無効`
  - 要確認：`★要確認`
- **★要確認の処理補助**
  - No指定で「有効/無効/★要確認/理由編集」
  - 理由テンプレ選択（無効／★要確認）（自由入力も可）
- **氏名不一致（顧客名簿 vs フォーム入力）**
  - `氏名不一致ログ` に記録
  - メニューから「次の1件を処理」（名簿更新／備考追記／却下）
- **バックアップ**
  - 日次バックアップ（保持/整理）
  - 月次スナップショット（保持）
  - 手動スナップショット（メニューから）
- **導入ツール**
  - 本番初期化（テストデータ削除）
  - フォーム送信トリガーの設定/削除
  - 日次準備トリガーの設定/削除
  - Script Properties の必須項目チェック
  - テンプレ配布用 Script Properties（ダミー値）の作成/上書き

---

## 全体フロー（概念）

```mermaid
flowchart LR
  A[LINE公式アカウント] -->|リッチメニュー/リンク| B[Googleフォーム]
  B --> C[フォーム回答]
  C -->|onFormSubmit| D[Apps Script]
  D --> E[スプレッドシート: 注文一覧/顧客名簿/当日まとめ/予約札]
  D --> F[LINEへ受付メッセージ]
  A <-->|Webhook| G[Apps Script WebApp doPost]
````

---

## 前提（用意するもの）

* Googleアカウント（スプレッドシート/フォーム/Apps Script）
* LINE公式アカウント（Messaging API）
* 本リポジトリ（Apps Script 一式）

---

## シート構成（必須）

スプレッドシートに以下のシート名が存在する前提です（テンプレ複製推奨）：

* `注文一覧`
* `顧客名簿`
* `メニューマスタ`
* `当日まとめ`
* `予約札`
* `★要確認一覧`
* `ログ`（任意：ログ出力先。無ければ自動作成される実装もあります）

> ※列構成は `Config.gs` の定義に依存します。新規導入時はテンプレート複製が安全です。

---

## 初期設定（新店舗・新環境の導入手順）

### 1) スプレッドシートを用意（テンプレを複製推奨）

テンプレ（運用実績のあるシート）を **ファイルごと複製**して新店舗用にするのが最も安全です。

### 2) Apps Script を紐付ける

* 複製したスプレッドシート → 拡張機能 → Apps Script
* 本リポジトリの `.gs` / `.html` / `appsscript.json` を反映

### 3) Script Properties を設定（必須/推奨）

Apps Script の「プロジェクトの設定」→「スクリプト プロパティ」に設定します。

#### 必須（最低限）

* `LINE_TOKEN`：LINE Messaging API のチャネルアクセストークン
* `WEBHOOK_KEY`：Webhook の簡易認証キー（URL の `?key=` で使用）

#### 推奨（運用：バックアップ）

* `BACKUP_FOLDER_ID`：バックアップ保存先の親フォルダID（Googleドライブ）
* `BACKUP_AT_HOUR`：日次バックアップ実行時刻（例：`3`）
* `BACKUP_DAILY_RETENTION_DAYS`：日次を何日残すか（例：`60`）
* `BACKUP_MONTHLY_RETENTION_MONTHS`：月次を何ヶ月残すか（例：`12`）
* `BACKUP_USE_MONTHLY_FOLDER`：`1` 推奨（Backups_YYYYMM フォルダ運用）
* `BACKUP_DAILY_FOLDER_KEEP_MONTHS`：古い月フォルダ掃除の目安（例：`12`）
* `BACKUP_MONTHLY_FOLDER_NAME`：月次スナップショット用フォルダ名（例：`MonthlySnapshots`）
* `BACKUP_MANUAL_FOLDER_NAME`：手動スナップショット用フォルダ名（例：`ManualSnapshots`）

#### 推奨（運用：日次準備＝当日まとめ+予約札の自動作成）

* `DAILY_PREP_AT_HOUR`：実行時刻（時）（例：`7`）
* `DAILY_PREP_AT_MINUTE`：実行時刻（分）（例：`0`）
* `DAILY_PREP_OFFSET_DAYS`：対象日のオフセット（例：`0`=今日、`1`=明日）

#### 任意（ログ/デバッグ）

* `LOG_LEVEL` / `LOG_MAX_ROWS`
* `DEBUG_MAIN` / `DEBUG_ORDER_SAVE`

> テンプレ配布用に、メニュー「導入ツール」内の
> 「テンプレ用プロパティ作成（未設定のみ）」/「テンプレ用プロパティ上書き（全部ダミー）」も使えます（値はダミー化されます）。

---

## Webhook（LINE）設定

本プロジェクトは Apps Script を **Webアプリ**としてデプロイし、LINE Webhook を受けます。

### 1) Webアプリとしてデプロイ

* デプロイ → 新しいデプロイ → 種類：ウェブアプリ
* 実行するユーザー：`自分`
* アクセス：`全員`（Webhook受信のため）

### 2) LINE Webhook URL

Webhook URL は次の形になります（例）：

`https://script.google.com/macros/s/DEPLOYMENT_ID/exec?key=WEBHOOK_KEY`

※URLの `?key=` は **必須**（簡易認証）です。

---

## トリガー設定（重要）

### フォーム送信トリガー（必須）

* スプレッドシート側の Apps Script で `onFormSubmit(e)` が起動するように設定します。
* メニュー「導入ツール」→「フォーム送信トリガー設定」で作成できます。

### 日次準備トリガー（推奨：当日まとめ+予約札の自動作成）

* 毎日指定時刻に `当日まとめ` と `予約札` を自動作成します。
* メニュー「導入ツール」→「日次準備トリガー設定（当日まとめ+予約札）」で作成できます。

### 日次バックアップトリガー（推奨）

* `BackupService.gs` の日次バックアップを **深夜帯（例：3時）** に設定推奨。
* Script Properties のバックアップ系が未設定だと動きません。

### ★要確認一覧の自動更新（任意）

* ★要確認一覧を定期更新（デフォルト 30分ごと）するトリガー機能があります。
* 必要なら `installNeedsCheckViewTrigger()` を実行して導入してください。

---

## メニューマスタの「自動返信表示名」について（任意）

### 目的

LINEの自動返信（お客様向け文面）で、**略称（内部キー）ではなく、読みやすい商品名**を表示するための仕組みです。
※予約変更の案内・確認文面にも適用されます。

### 設定方法

`メニューマスタ` に列を用意します：

* `SHORT_NAME`（略称・内部キー）：内部処理/識別用
* `AUTO_REPLY_NAME`（任意）：お客様向け表示名（空欄なら従来の表記にフォールバック）

---

## 日々の運用（オペレーション）

### ① 朝（当日分の準備）

1. メニュー「★予約管理」→「★要確認一覧を更新」
2. （手動の場合）

   * 「日次準備（当日まとめ+予約札：指定日まとめて）」を実行（プロンプト1回で両方作成）
   * または個別に「当日まとめシートを更新」「指定日の予約札を作成」

> 日次準備トリガーを入れている場合は、朝の作成が自動化されます。

### ② 要確認の処理

* 「★要確認一覧」を見ながら対応します。
* 対応は基本「No指定」メニューで行います（事故が減る）：

  * 有効に戻す / 無効にする（理由必須） / ★要確認にする（理由必須） / 理由だけ編集

### ③ 氏名不一致の処理（任意）

* メニュー「氏名不一致」→「ログを開く」で一覧確認
* 「次の1件を処理」で、顧客名簿の更新方針を選びます：

  1. 名前を更新（上書き）
  2. 別名として備考(事務)に追記（名前は維持）
  3. 却下（何もしない）

### ④ 顧客備考の更新（調理/事務）

* 「顧客備考を編集（サイドバー）」から更新します。

---

## バックアップ運用

### 自動（日次＋月次）

* 日次：一定期間保持しつつ整理
* 月次：スナップショットとして保持

### 手動（大きな変更の前に推奨）

* メニュー「バックアップ」→「手動スナップショット作成」
* 店側の大きな変更（列追加、運用切替、マスタ入替など）の前に推奨

---

## トラブルシュート

### 「onFormSubmit は完了しているのに注文一覧に反映されない」

まず以下を確認してください：

* フォーム送信トリガーが **正しいプロジェクト** に入っているか（別スプレッドシートに入っていないか）
* `注文一覧` シート名が一致しているか（テンプレから変えていないか）
* Script Properties（`LINE_TOKEN` / `WEBHOOK_KEY`）が未設定になっていないか
* Apps Script の「実行ログ」「エラー」を確認（例外で止まっていないか）

---

## リポジトリ構成（主要ファイル）

* `System.gs`：スプレッドシートのメニュー（★予約管理）定義
* `Main.gs`：メイン処理（フォーム→保存→通知 などの起点）
* `LineWebhook.gs`：Webhook受信（doPost）
* `LineService.gs`：LINE送信（push/reply など）
* `DailyPrepService.gs`：日次準備（当日まとめ+予約札の自動/手動まとめ実行）
* `BackupService.gs`：日次/月次/手動スナップショット
* `AdminTools.gs`：ステータス移行/運用ガード/理由テンプレ等
* `ProductionSheet.gs`：当日まとめ生成
* `ReservationCards.gs`：予約札生成
* `CustomerService.gs` / `CustomerForm.html`：顧客名簿・備考編集UI／氏名不一致ログ
* `Config.gs`：シート名、フォーム項目名、列定義、プロパティキー等
* `ScriptProps.gs`：Script Properties の参照/検証（キー定義は Config に集約）
* `SecurityUtils.gs`：数式注入対策/制御文字除去など
* `SheetLogger.gs`：ログシートへの実行ログ出力
* `appsscript.json`：タイムゾーン/ランタイム/WebApp設定

---

## セキュリティ注意

* Webアプリは「全員」アクセスで公開しますが、URL に `?key=` を必須化して簡易認証しています。
* Script Properties（特に `LINE_TOKEN`）は **GitHub にコミットしない**でください。
* Webhook側は **重複排除（Cache）** と **payloadサイズ制限** も入っています。

---

## ライセンス

必要に応じて追記してください（未設定の場合は `LICENSE` を追加推奨）。

```

### 反映ポイント（現行版に合わせた追記）
- **日次準備（当日まとめ+予約札）**：トリガー実行＆手動プロンプト実行をREADMEに追記【turn24file1†repomix-output-tree-3.2.md†L27-L34】【turn24file0†repomix-output-tree-3.2.md†L22-L34】
- **導入ツールに日次準備トリガー設定/削除が存在**する点を反映【turn24file2†repomix-output-tree-3.2.md†L20-L28】
- **日次準備用の Script Properties（`DAILY_PREP_*`）** をプロパティ一覧に追加【turn23file5†repomix-output-tree-3.2.md†L25-L29】
- **自動返信表示名（`AUTO_REPLY_NAME`）** の運用説明を追加（メニューマスタ列定義＆返信整形ロジック）【turn24file6†repomix-output-tree-3.2.md†L32-L41】【turn23file13†repomix-output-tree-3.2.md†L13-L35】【turn24file7†repomix-output-tree-3.2.md†L105-L109】

このREADMEをそのまま `README.md` に差し替えればOKです。必要なら、店舗導入用に「チェックリスト（運用手順）」セクションも追記して、さらに現場向けにできます。
```
